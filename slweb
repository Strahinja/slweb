#!/bin/bash

BODY_ONLY=0
CSSFILE=index.css
INFILE=index.slw
OUTFILE=index.html
VERSION=v0.1-beta

function throw()
{
    echo $1 1>&2
    exit 1
}

function version()
{
    cat <<EOT
Slweb $VERSION
EOT
    return 1
}

function usage()
{
    cat <<EOT
usage: $(basename $0) [-b|--body-only] [-d <dir>|--basedir <dir>] [-h|--help] [-v|--version] <file>
EOT
    return 1
}

function begin_html()
{
cat <<EOT
<!DOCTYPE html>
<html lang="en">
EOT
}

function end_html()
{
cat <<EOT
</html>
EOT
}

function begin_head()
{
cat <<EOT
<head>
EOT
}

function head()
{
cat <<EOT
    <title>${VARS[site-name]}</title>
    <meta charset="utf8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="slweb" />
EOT
}

function add_css()
{
    cat <<EOT
    <link rel="stylesheet" href="$1" />
EOT
}

function end_head()
{
cat <<EOT
</head>
EOT
}

function begin_body()
{
cat <<EOT
<body>
EOT
}

function body()
{
    BODY=$(echo "$1" | \
        sed -e's/#### \([^\n]*\)$/<h4>\1<\/h4>/g' \
            -e's/### \([^\n]*\)$/<h3>\1<\/h3>/g' \
            -e's/## \([^\n]*\)$/<h2>\1<\/h2>/g' \
            -e's/# \([^\n]*\)$/<h1>\1<\/h1>/g' \
            -e 's/\*\*\([^*]\+\)\*\*/<strong>\1<\/strong>/g' \
            -e 's/\*\([^*]\+\)\*/<em>\1<\/em>/g' \
            -e 's/_\([^_]\+\)_/<em>\1<\/em>/g' \
            -e 's/{\.\(.*\)}/<div class="\1">/' \
            -e 's/{\/\.\(.*\)}/<\/div><!--\1-->/' \
            -e 's/{#\(.*\)}/<div id="\1">/' \
            -e 's/{\/#\(.*\)}/<\/div><!--\1-->/' \
            -e "s/{made-by}/$MADEBY/g" \
            -e 's/{\([a-z-]\+\)}/<\1>/g' \
            -e 's/{\/\([a-z-]\+\)}/<\/\1>/g' \
            -e "s/\\[\\([^]]\\+\\)\\](\\([^)]\\+\\))/<a href=\"$(realpath --relative-to=$BASEDIR $(dirname $INFILE) | sed -e's/\//\\\//g')\/\\2\">\\1<\\/a>/" | \
        sed -e '1h;2,$H;$!d;g;s/\n\n\([^<{\n]\+\)/\n\n<p>\1/g' | \
        sed -e '1h;2,$H;$!d;g;s/\([^>}\n]\)\n\n/\1<\/p>\n\n/g' | \
        sed -e '1h;2,$H;$!d;g;s/\([^>}\n]\)$/\1<\/p>\n\n/g')

    INCLUDE=$(echo "$BODY" | \
        sed -e'/{include/s/.*{include \"\([.\/a-z ]\+\)\"}.*/\1/;t;d' | \
        sed 1q)

    while [ ! -z "$INCLUDE" ]; do
        INCLUDE_BODY=$($0 -b -d $(dirname $INFILE) "$(dirname $INFILE)/$INCLUDE.slw")
        BODY=$(echo "$BODY" | \
            sed -e"s/{include \\\"$(echo $INCLUDE | sed -e's/\//\\\//g')\\\"}/$(echo $INCLUDE_BODY | sed -e's/\//\\\//g')/")
        INCLUDE=$(echo "$BODY" | \
            sed -e'/{include/s/.*{include \"\([.\/a-z ]\+\)\"}.*/\1/;t;d' | \
            sed 1q)
    done
    echo "$BODY"
}

function end_body()
{
cat <<EOT
</body>
EOT
}

BASEDIR=.
MADEBY=$(cat <<EOT | sed -e's/\//\\\//g' -e"s/\"/\\\\\"/g" | sed -z -e's/\n/\\n/g'
<div id="made-by">
Generated by <a href="https://github.com/Strahinja/slweb">slweb</a>
Â© 2020 Strahinya Radich.
</div><!--made-by-->
EOT
)

while [ $# -gt 0 ]; do
    case "$1" in
        -v|--version) version; exit
            ;;
        -h|--help) usage; exit
            ;;
        -b|--body-only) BODY_ONLY=1
            ;;
        -d|--basedir) shift; BASEDIR=$1
            ;;
        *) INFILE=$1
            ;;
    esac
    shift
done

[ -f $INFILE ] || throw "$INFILE not present"

declare -A VARS
VAR_KEYS=$(grep '\([a-z-]\+\): \(.*\)' $INFILE | \
    sed -e's/\([a-z-]\+\): \(.*\)/\1/g')
for key in $VAR_KEYS; do
    VARS[$key]=$(grep "$key:" $INFILE | \
        sed -e "s/$key: \(.*\)/\1/g") 
done

#echo -n Generating ${VARS[site-name]}: ${VARS[site-desc]}...

grep -- '---' $INFILE 2>&1 >/dev/null \
    && DOC=$(sed '0,/---/d' $INFILE) \
    || DOC=$(cat $INFILE)

CSSHREF=$CSSFILE
INDIR=$(dirname $INFILE 2>/dev/null)
[ "$INDIR" != "." ] && CSSHREF=../$CSSFILE
#echo CSSHREF=$CSSHREF >&2

if [ $BODY_ONLY -eq 0 ]; then
    begin_html
    begin_head
    head
    [ -f $CSSFILE ] && add_css $CSSHREF
    end_head
    begin_body
fi
body "$DOC"
if [ $BODY_ONLY -eq 0 ]; then
    end_body
    end_html
fi

#echo done.
